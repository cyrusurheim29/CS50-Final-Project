<!DOCTYPE html>

<html lang="en">
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <link href="static/styles.css" rel="stylesheet">
        <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=visualization"></script>
        <title>{% block title %}{% endblock %}</title>
    <script>
        let map;
        let currentInfoWindow = null; // Track the currently open info window
        let currentMarker = null;     // Track the currently clicked marker

        const markerColors = {
            "Boston Community Center": "purple",
            "Food Kitchen": "red",
            "Homeless Shelter": "blue",
            "Medical Help": "green",
            "Animal Care": "yellow"
        };

        // Store markers by classification
        const markersByClassification = {
            "Food Kitchen": [],
            "Homeless Shelter": [],
            "Medical Help": [],
            "Animal Care": [],
            "Boston Community Center": []
        };

        function initMap() {
            const boston = { lat: 42.3601, lng: -71.0589 };

            // Create the map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: boston,
            });

            // Add the legend
            createLegend();

            // Fetch and display markers
            fetch("/data")
                .then(response => response.json())
                .then(data => {
                    data.forEach(opportunity => {
                        fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(opportunity.address)}&key={{ api_key }}`)
                            .then(response => response.json())
                            .then(geoData => {
                                // Check geocode status and handle errors
                                if (geoData.status === "OK") {
                                    const location = geoData.results[0].geometry.location;
                                    
                                    // Create a marker
                                    const marker = new google.maps.Marker({
                                        position: location,
                                        map: map,
                                        title: opportunity.name,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            fillColor: markerColors[opportunity.classification],
                                            fillOpacity: 1,
                                            strokeWeight: 0,
                                            scale: 8,
                                        },
                                    });

                                    // Create an info window
                                    const infoWindow = new google.maps.InfoWindow({
                                        content: `
                                            <h3>${opportunity.name}</h3>
                                            <p>${opportunity.classification}</p>
                                            <a href="${opportunity.webpage}" target="_blank">Visit Webpage</a>
                                        `,
                                    });

                                    // Toggle info window on marker click
                                    marker.addListener("click", () => {
                                        if (currentInfoWindow && currentMarker === marker) {
                                            // Close the current info window if the same marker is clicked again
                                            currentInfoWindow.close();
                                            currentInfoWindow = null;
                                            currentMarker = null;
                                        } else {
                                            // Close the previous info window, if any
                                            if (currentInfoWindow) {
                                                currentInfoWindow.close();
                                            }
                                            // Open the new info window
                                            infoWindow.open(map, marker);
                                            currentInfoWindow = infoWindow;
                                            currentMarker = marker;
                                        }
                                    });

                                    // Store the marker in the appropriate classification array
                                    markersByClassification[opportunity.classification].push(marker);
                                } else {
                                    console.error(`Geocoding failed for address: ${opportunity.address}`);
                                }
                            })
                            .catch(err => {
                                console.error(`Error fetching geocoding data: ${err}`);
                            });
                    });
                })
                .catch(err => console.error("Error fetching data:", err));
            // Heatmap data: 500 Points
            fetch('/static/fi_heatmap_data.json')
                .then(response => response.json())
                .then(data => {
                    const heatmapData = data.map(item => ({
                        location: new google.maps.LatLng(item.location.lat, item.location.lng),
                        weight: item.weight,
                    }));

            // Create the heatmap layer and add it to the map
            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                radius: 100
                 // Ensure map instance is passed here
            });
            heatmap.setMap(map);
            // Add a toggle button for the heatmap
            const heatmapToggle = document.createElement("button");
                heatmapToggle.textContent = "Food Insecurity";
                heatmapToggle.classList.add("btn", "btn-primary");
                heatmapToggle.style.position = "absolute";
                heatmapToggle.style.top = "10px";
                heatmapToggle.style.left = "10px";
                heatmapToggle.onclick = () => {
                    heatmap.setMap(heatmap.getMap() ? null : map); // Toggle visibility
                };
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(heatmapToggle);
        });
        fetch('/static/pov_heatmap_data.json')
                .then(response => response.json())
                .then(data => {
                    const heatmapData = data.map(item => ({
                        location: new google.maps.LatLng(item.location.lat, item.location.lng),
                        weight: item.weight,
                    }));

            // Create the heatmap layer and add it to the map
            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                radius: 100
                 // Ensure map instance is passed here
            });
            heatmap.setMap(map);
            // Add a toggle button for the heatmap
            const heatmapToggle = document.createElement("button");
                heatmapToggle.textContent = "Poverty Rate";
                heatmapToggle.classList.add("btn", "btn-primary");
                heatmapToggle.style.position = "absolute";
                heatmapToggle.style.top = "10px";
                heatmapToggle.style.left = "10px";
                heatmapToggle.onclick = () => {
                    heatmap.setMap(heatmap.getMap() ? null : map); // Toggle visibility
                };
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(heatmapToggle);
        });

        fetch('/static/aa_heatmap_data.json')
                .then(response => response.json())
                .then(data => {
                    const heatmapData = data.map(item => ({
                        location: new google.maps.LatLng(item.location.lat, item.location.lng),
                        weight: item.weight,
                    }));

            // Create the heatmap layer and add it to the map
            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                radius: 100
                 // Ensure map instance is passed here
            });
            heatmap.setMap(map);
            // Add a toggle button for the heatmap
            const heatmapToggle = document.createElement("button");
                heatmapToggle.textContent = "Percent African American Population";
                heatmapToggle.classList.add("btn", "btn-primary");
                heatmapToggle.style.position = "absolute";
                heatmapToggle.style.top = "10px";
                heatmapToggle.style.left = "10px";
                heatmapToggle.onclick = () => {
                    heatmap.setMap(heatmap.getMap() ? null : map); // Toggle visibility
                };
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(heatmapToggle);
        });


        fetch('/static/lat_heatmap_data.json')
                .then(response => response.json())
                .then(data => {
                    const heatmapData = data.map(item => ({
                        location: new google.maps.LatLng(item.location.lat, item.location.lng),
                        weight: item.weight,
                    }));

            // Create the heatmap layer and add it to the map
            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                radius: 100
                 // Ensure map instance is passed here
            });
            heatmap.setMap(map);
            // Add a toggle button for the heatmap
            const heatmapToggle = document.createElement("button");
                heatmapToggle.textContent = "Percent Latinx Population";
                heatmapToggle.classList.add("btn", "btn-primary");
                heatmapToggle.style.position = "absolute";
                heatmapToggle.style.top = "10px";
                heatmapToggle.style.left = "10px";
                heatmapToggle.onclick = () => {
                    heatmap.setMap(heatmap.getMap() ? null : map); // Toggle visibility
                };
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(heatmapToggle);
        });
    }
    
        // Create and add the legend
        function createLegend() {
            const legend = document.createElement('div');
            legend.id = 'legend';
            legend.innerHTML = '<h3>Classification Legend</h3>';

            for (const [classification, color] of Object.entries(markerColors)) {
                const div = document.createElement('div');
                div.innerHTML = `<span style="background-color: ${color}; width: 15px; height: 15px; display: inline-block; margin-right: 8px;"></span>${classification}`;
                
                // Add a click listener to toggle the visibility of the markers
                div.addEventListener('click', () => toggleMarkers(classification));

                legend.appendChild(div);
            }

            legend.style.backgroundColor = 'white';
            legend.style.border = '1px solid black';
            legend.style.padding = '10px';
            legend.style.margin = '10px';
            legend.style.fontSize = '14px';
            legend.style.maxWidth = '200px';

            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
        }

        // Toggle visibility of markers based on classification
        function toggleMarkers(classification) {
            const markers = markersByClassification[classification];
            const visible = markers[0].getMap() !== null;  // Check if any marker is currently visible

            markers.forEach(marker => {
                marker.setMap(visible ? null : map);  // If visible, hide; if hidden, show
            });
        }
        window.initMap = initMap;
    </script>            
    </head>
    <body>    
        {% block body %}
        {% endblock %}
    </body>
    <main class="container py-5 text-center">
        {% block main %}
        {% endblock %}
    </main>
    <div id="footer">
        <div class="text">
            STATEMENT
        </div>
        <div class="copyright">2024 Equal Opportunity Boston. No rights reserved. Public Policy</div>
    </div>
</html>
