<!DOCTYPE html>
<html>
<head>
    <title>Volunteer Opportunities in Boston</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}"></script>
    <script>
        // Initialize and add the map
        function initMap() {
            // Center map on Boston
            const boston = { lat: 42.3601, lng: -71.0589 };

            // Create the map
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: boston,
            });

            // Variables to track the currently open info window and marker
            let currentInfoWindow = null;
            let currentMarker = null;

            // Fetch data from the server
            fetch("/data")
                .then(response => response.json())
                .then(data => {
                    data.forEach(opportunity => {
                        // Geocode the address to get latitude and longitude
                        fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(opportunity.address)}&key={{ api_key }}`)
                            .then(response => response.json())
                            .then(geoData => {
                                if (geoData.status === "OK") {
                                    const location = geoData.results[0].geometry.location;

                                    // Create a marker
                                    const marker = new google.maps.Marker({
                                        position: location,
                                        map: map,
                                        title: opportunity.name,
                                    });

                                    // Create an info window with proper HTML content
                                    const infoWindow = new google.maps.InfoWindow({
                                        content: `
                                            <h3>${opportunity.name}</h3>
                                            <p>${opportunity.classification}</p>
                                            <a href="${opportunity.webpage}" target="_blank">Visit Webpage</a>
                                        `,
                                    });

                                    // Add click listener to toggle info window
                                    marker.addListener("click", () => {
                                        if (currentInfoWindow && currentMarker === marker) {
                                            // If the same marker is clicked, close its info window
                                            currentInfoWindow.close();
                                            currentInfoWindow = null;
                                            currentMarker = null;
                                        } else {
                                            // Close the previous info window, if any
                                            if (currentInfoWindow) {
                                                currentInfoWindow.close();
                                            }
                                            // Open the new info window
                                            infoWindow.open(map, marker);
                                            currentInfoWindow = infoWindow;
                                            currentMarker = marker;
                                        }
                                    });
                                }
                            });
                    });
                });
        }
    </script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body onload="initMap()">
    <h1>Volunteer Opportunities in Boston</h1>
    <div id="map"></div>
</body>
</html>
