<!DOCTYPE html>
<html>
<head>
    <title>Volunteer Opportunities in Boston</title>
    <!-- Load the Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>
    <script>
        let map;
        let currentInfoWindow = null; // Track the currently open info window
        let currentMarker = null;     // Track the currently clicked marker

        const markerColors = {
            "Food Kitchen": "red",
            "Homeless Shelter": "blue",
            "Medical Help": "green",
            "Animal Care": "yellow",
            "Boston Community Center": "purple"
        };

        function initMap() {
            const boston = { lat: 42.3601, lng: -71.0589 };

            // Create the map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: boston,
            });

            // Add the legend
            createLegend();

            // Fetch and display markers
            fetch("/data")
                .then(response => response.json())
                .then(data => {
                    data.forEach(opportunity => {
                        fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(opportunity.address)}&key={{ api_key }}`)
                            .then(response => response.json())
                            .then(geoData => {
                                // Check geocode status and handle errors
                                if (geoData.status === "OK") {
                                    const location = geoData.results[0].geometry.location;

                                    // Create a marker
                                    const marker = new google.maps.Marker({
                                        position: location,
                                        map: map,
                                        title: opportunity.name,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            fillColor: markerColors[opportunity.classification],
                                            fillOpacity: 1,
                                            strokeWeight: 0,
                                            scale: 8,
                                        },
                                    });

                                    // Create an info window
                                    const infoWindow = new google.maps.InfoWindow({
                                        content: `
                                            <h3>${opportunity.name}</h3>
                                            <p>${opportunity.classification}</p>
                                            <a href="${opportunity.webpage}" target="_blank">Visit Webpage</a>
                                        `,
                                    });

                                    // Toggle info window on marker click
                                    marker.addListener("click", () => {
                                        if (currentInfoWindow && currentMarker === marker) {
                                            // Close the current info window if the same marker is clicked again
                                            currentInfoWindow.close();
                                            currentInfoWindow = null;
                                            currentMarker = null;
                                        } else {
                                            // Close the previous info window, if any
                                            if (currentInfoWindow) {
                                                currentInfoWindow.close();
                                            }
                                            // Open the new info window
                                            infoWindow.open(map, marker);
                                            currentInfoWindow = infoWindow;
                                            currentMarker = marker;
                                        }
                                    });
                                } else {
                                    console.error(`Geocoding failed for address: ${opportunity.address}`);
                                    console.error(`Error status: ${geoData.status}`);
                                    if (geoData.status === "ZERO_RESULTS") {
                                        console.error("No results found for the address.");
                                    } else if (geoData.status === "OVER_QUERY_LIMIT") {
                                        console.error("You have exceeded your daily request limit.");
                                    } else {
                                        console.error("An unknown error occurred during geocoding.");
                                    }
                                }
                            })
                            .catch(err => {
                                console.error(`Error fetching geocoding data: ${err}`);
                            });
                    });
                })
                .catch(err => console.error("Error fetching data:", err));
        }

        // Create and add the legend
        function createLegend() {
            const legend = document.createElement('div');
            legend.id = 'legend';
            legend.innerHTML = '<h3>Classification Legend</h3>';

            for (const [classification, color] of Object.entries(markerColors)) {
                const div = document.createElement('div');
                div.innerHTML = `<span style="background-color: ${color}; width: 15px; height: 15px; display: inline-block; margin-right: 8px;"></span>${classification}`;
                legend.appendChild(div);
            }

            legend.style.backgroundColor = 'white';
            legend.style.border = '1px solid black';
            legend.style.padding = '10px';
            legend.style.margin = '10px';
            legend.style.fontSize = '14px';
            legend.style.maxWidth = '200px';

            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
        }
    </script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Volunteer Opportunities in Boston</h1>
    <div id="map"></div>
</body>
</html>
